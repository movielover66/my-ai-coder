<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1e1e1e">
    <title>AI Code Studio (Secure)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* --- APP STYLE --- */
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: 'Segoe UI', monospace; background: #1e1e1e; color: #ccc; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* Header / Toolbar */
        header { background: #252526; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; height: 60px; }
        
        .logo-area { display: flex; flex-direction: column; }
        h3 { margin: 0; color: #007acc; font-size: 16px; }
        .status-text { font-size: 10px; color: #666; }

        /* API Key Input Area */
        .api-box { display: flex; gap: 5px; }
        .api-input { 
            background: #333; border: 1px solid #444; color: #fff; padding: 5px 10px; border-radius: 4px; font-size: 12px; width: 150px;
        }
        .btn-save-key { background: #333; color: #00ff88; border: 1px solid #00ff88; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 11px; }

        .btn-primary { background: #007acc; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; margin-left: 10px; }
        .btn-danger { background: #d9453b; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; }
        
        /* Main Layout */
        .workspace { display: flex; height: calc(100vh - 60px); }
        
        /* Sidebar */
        .sidebar { width: 250px; background: #252526; border-right: 1px solid #333; overflow-y: auto; display: flex; flex-direction: column; }
        .sidebar-header { padding: 10px; font-size: 11px; font-weight: bold; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        
        .folder-group { margin-bottom: 5px; }
        .folder-title { padding: 5px 15px; color: #fff; font-size: 12px; font-weight: bold; background: #333; cursor: default; }
        
        .file-item { 
            padding: 8px 20px; font-size: 13px; color: #aaa; cursor: pointer; border-left: 3px solid transparent; display: flex; justify-content: space-between; align-items: center;
        }
        .file-item:hover { background: #2a2d2e; color: #fff; }
        .file-item.active { background: #37373d; color: #fff; border-left-color: #007acc; }
        .file-item.duplicate { color: #ff6b6b; }
        
        .badge { font-size: 9px; padding: 2px 4px; border-radius: 3px; }
        .badge-dup { background: #5a1d1d; color: #ff6b6b; }

        /* Editor Area */
        .editor-container { flex: 1; display: flex; flex-direction: column; background: #1e1e1e; position: relative; }
        .editor-tabs { display: flex; background: #252526; height: 35px; align-items: center; padding-left: 10px; border-bottom: 1px solid #1e1e1e; }
        .tab-name { font-size: 13px; color: #fff; padding: 5px 10px; background: #1e1e1e; border-top: 2px solid #007acc; }
        .no-file { flex: 1; display: flex; justify-content: center; align-items: center; color: #444; font-size: 20px; flex-direction: column; }

        textarea.code-editor {
            flex: 1; width: 100%; background: #1e1e1e; color: #d4d4d4; border: none; padding: 15px;
            font-family: 'Consolas', 'Courier New', monospace; font-size: 14px; line-height: 1.5; resize: none;
        }

        /* AI Panel */
        .ai-panel { background: #252526; padding: 10px; border-top: 1px solid #333; display: none; }
        .ai-input-group { display: flex; gap: 10px; }
        .ai-input { flex: 1; background: #3c3c3c; border: 1px solid #555; color: white; padding: 8px; border-radius: 4px; }
        .btn-ai { background: linear-gradient(90deg, #007acc, #00d2ff); border: none; padding: 0 20px; font-weight: bold; border-radius: 4px; cursor: pointer; color: #000; }
        
        @media (max-width: 768px) {
            .workspace { flex-direction: column; }
            .sidebar { width: 100%; height: 35%; border-right: none; border-bottom: 1px solid #333; }
            .editor-container { height: 65%; }
            header { height: auto; flex-wrap: wrap; gap: 10px; padding: 10px; }
        }
    </style>
</head>
<body>

<header>
    <div class="logo-area">
        <h3>‚ö° AI Code Studio</h3>
        <span class="status-text" id="keyStatus">üî¥ No API Key Set</span>
    </div>
    
    <div class="api-box">
        <input type="password" id="userApiKey" class="api-input" placeholder="Paste Gemini API Key">
        <button class="btn-save-key" onclick="saveKey()">Set Key</button>
    </div>

    <div style="display:flex; gap:5px;">
        <input type="file" id="zipInput" accept=".zip" style="display:none">
        <button class="btn-primary" onclick="document.getElementById('zipInput').click()">üìÇ ZIP</button>
        <button class="btn-primary" id="dlBtn" onclick="downloadZip()" style="display:none; background:#28a745;">‚¨áÔ∏è Save</button>
    </div>
</header>

<div class="workspace">
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">EXPLORER</div>
        <div id="fileList">
            <div style="padding:20px; text-align:center; color:#555;">Open a Zip File</div>
        </div>
    </div>

    <div class="editor-container">
        <div class="editor-tabs" id="editorHeader" style="display:none;">
            <span class="tab-name" id="currentFileName">script.js</span>
            <div style="flex:1; text-align:right; padding-right:10px;">
                <button class="btn-danger" onclick="deleteCurrentFile()">üóëÔ∏è</button>
            </div>
        </div>

        <div id="emptyState" class="no-file">
            <p>Select a file to edit</p>
        </div>
        
        <textarea class="code-editor" id="codeEditor" spellcheck="false" style="display:none;"></textarea>

        <div class="ai-panel" id="aiPanel">
            <div class="ai-input-group">
                <input type="text" class="ai-input" id="aiPrompt" placeholder="Write instructions for AI...">
                <button class="btn-ai" id="aiBtn" onclick="runAI()">‚ú® Run AI</button>
            </div>
            <div id="aiStatus" style="font-size:11px; color:#00ff88; margin-top:5px; height:15px;"></div>
        </div>
    </div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    let genAI = null;
    let model = null;
    let files = {};
    let currentFile = null;

    // --- 1. API KEY HANDLING ---
    window.saveKey = function() {
        const key = document.getElementById('userApiKey').value;
        if(key.length < 10) return alert("Invalid API Key");
        
        try {
            genAI = new GoogleGenerativeAI(key);
            model = genAI.getGenerativeModel({ model: "gemini-2.0-flash" });
            
            // UI Feedback
            document.getElementById('keyStatus').innerText = "üü¢ System Ready";
            document.getElementById('keyStatus').style.color = "#00ff88";
            document.getElementById('userApiKey').style.border = "1px solid #00ff88";
            alert("API Key Connected Successfully!");
        } catch (e) {
            alert("Error connecting API: " + e.message);
        }
    }

    // --- 2. ZIP HANDLING ---
    document.getElementById('zipInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const zip = new JSZip();
        const content = await zip.loadAsync(file);
        
        files = {};
        let contentHashes = new Set();

        for (let name in content.files) {
            const f = content.files[name];
            if (!f.dir && !name.includes("__MACOSX")) {
                const text = await f.async("string");
                
                const hash = text.length + "-" + text.substring(0, 50);
                if (contentHashes.has(hash)) {
                    files[name + " [DUPLICATE]"] = text;
                } else {
                    contentHashes.add(hash);
                    files[name] = text;
                }
            }
        }
        renderSidebar();
        document.getElementById('dlBtn').style.display = 'block';
    });

    // --- 3. RENDER SIDEBAR ---
    function renderSidebar() {
        const list = document.getElementById('fileList');
        list.innerHTML = "";
        
        // Custom sort to group files
        const sortedKeys = Object.keys(files).sort();

        sortedKeys.forEach(fname => {
            const isDup = fname.includes("[DUPLICATE]");
            const item = document.createElement('div');
            item.className = `file-item ${isDup ? 'duplicate' : ''}`;
            
            // Icon Logic
            let icon = "üìÑ";
            if(fname.includes(".html")) icon = "üåê";
            if(fname.includes(".css")) icon = "üé®";
            if(fname.includes(".js")) icon = "‚öôÔ∏è";

            item.innerHTML = `
                <span>${icon} ${fname.replace(" [DUPLICATE]", "")}</span>
                ${isDup ? '<span class="badge badge-dup">DUP</span>' : ''}
            `;
            item.onclick = () => openFile(fname, item);
            list.appendChild(item);
        });
    }

    // --- 4. EDITOR LOGIC ---
    function openFile(name, element) {
        currentFile = name;
        document.querySelectorAll('.file-item').forEach(el => el.classList.remove('active'));
        element.classList.add('active');

        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('editorHeader').style.display = 'flex';
        document.getElementById('codeEditor').style.display = 'block';
        document.getElementById('aiPanel').style.display = 'block';
        
        document.getElementById('currentFileName').innerText = name.replace(" [DUPLICATE]", "");
        document.getElementById('codeEditor').value = files[name];
    }

    // --- 5. AI UPDATE LOGIC ---
    window.runAI = async function() {
        if (!model) return alert("Please set your API Key in the header first!");
        
        const prompt = document.getElementById('aiPrompt').value;
        const btn = document.getElementById('aiBtn');
        const status = document.getElementById('aiStatus');
        
        btn.disabled = true;
        btn.innerText = "Working...";
        status.innerText = "ü§ñ Analyzing code...";

        try {
            const aiPrompt = `
            ROLE: Expert Coder.
            TASK: Update the code based on instruction.
            FILE: ${currentFile}
            INSTRUCTION: "${prompt}"
            CODE:
            ${files[currentFile]}
            
            OUTPUT: ONLY raw code. No markdown.
            `;

            const result = await model.generateContent(aiPrompt);
            const response = await result.response;
            const newCode = response.text().replace(/```(javascript|html|css|json)?/g, "").replace(/```/g, "").trim();

            files[currentFile] = newCode;
            document.getElementById('codeEditor').value = newCode;
            status.innerText = "‚úÖ Updated!";
        } catch (error) {
            status.innerText = "‚ùå Error: " + error.message;
        } finally {
            btn.disabled = false;
            btn.innerText = "‚ú® Run AI";
        }
    }

    // --- 6. UTILS ---
    window.deleteCurrentFile = function() {
        if(confirm("Delete this file?")) {
            delete files[currentFile];
            currentFile = null;
            document.getElementById('emptyState').style.display = 'flex';
            document.getElementById('codeEditor').style.display = 'none';
            document.getElementById('aiPanel').style.display = 'none';
            document.getElementById('editorHeader').style.display = 'none';
            renderSidebar();
        }
    }

    window.downloadZip = function() {
        const zip = new JSZip();
        Object.keys(files).forEach(name => {
            zip.file(name.replace(" [DUPLICATE]", ""), files[name]);
        });
        zip.generateAsync({type:"blob"}).then(c => saveAs(c, "Project_Updated.zip"));
    }
</script>

</body>
</html>
