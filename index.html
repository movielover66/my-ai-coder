<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Smart Editor & Manager</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', monospace; background-color: #121212; color: #e0e0e0; padding: 20px; }
        h2 { color: #00ff88; text-align: center; }
        .container { max-width: 950px; margin: 0 auto; }

        /* Upload Zone */
        .upload-zone {
            border: 2px dashed #444; padding: 30px; text-align: center;
            background: #1e1e1e; border-radius: 10px; cursor: pointer; margin-bottom: 20px;
        }
        .upload-zone:hover { border-color: #00ff88; background: #252526; }

        /* File List */
        .file-item { background: #1e1e1e; border: 1px solid #333; margin-bottom: 10px; border-radius: 5px; overflow: hidden; }
        .file-header {
            padding: 12px 15px; display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; background: #252526; transition: 0.2s;
        }
        .file-header:hover { background: #2d2d2d; }
        
        .file-info { display: flex; align-items: center; gap: 10px; }
        .file-name { color: #00d2ff; font-weight: bold; }
        
        /* Badges */
        .badge-dup { background: #ff4d4d; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; display: none; }
        .badge-type { background: #444; color: #ccc; font-size: 10px; padding: 2px 6px; border-radius: 4px; }

        /* Buttons */
        .actions button { cursor: pointer; margin-left: 5px; border: none; padding: 6px 10px; border-radius: 4px; font-weight: bold; }
        .btn-edit { background: #00d2ff; color: #000; }
        .btn-del { background: #ff4d4d; color: #fff; }
        .btn-dl { background: #333; color: #fff; border: 1px solid #555; }

        /* Editor Area */
        .editor-area { display: none; padding: 15px; background: #151515; border-top: 1px solid #333; }
        
        /* Code Viewer */
        .code-box {
            width: 100%; height: 200px; background: #0f0f0f; color: #a9ff99;
            border: 1px solid #333; padding: 10px; border-radius: 5px;
            font-family: 'Courier New', monospace; font-size: 13px; margin-bottom: 10px;
            resize: vertical;
        }
        
        /* AI Input */
        .ai-input {
            width: 100%; height: 60px; background: #222; color: #fff;
            border: 1px solid #444; padding: 10px; border-radius: 5px; margin-bottom: 10px;
        }
        
        .btn-ai {
            width: 100%; padding: 10px; background: linear-gradient(45deg, #00ff88, #008cff);
            border: none; color: #000; font-weight: bold; cursor: pointer; border-radius: 5px;
        }
        .loading { color: #ffff00; margin-top: 5px; display: none; font-size: 12px; }

        /* Global Actions */
        .global-actions { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .btn-main { background: #ffc107; color: #000; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>‚ö° AI Smart Code Manager</h2>

    <div class="global-actions">
        <button onclick="document.getElementById('zipInput').click()" class="btn-main" style="background:#444; color:white">üìÇ Upload New Zip</button>
        <button onclick="downloadAll()" class="btn-main" id="dlAllBtn" style="display:none;">üì¶ Download Full Project</button>
    </div>

    <input type="file" id="zipInput" accept=".zip" style="display:none">
    
    <div id="fileContainer"></div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
    import { API_KEY } from './api.js';

    const genAI = new GoogleGenerativeAI(API_KEY);
    const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash" });

    let projectFiles = {}; 

    // Handle Zip Upload
    document.getElementById('zipInput').addEventListener('change', async function(event) {
        const file = event.target.files[0];
        if (!file) return;

        const zip = new JSZip();
        const content = await zip.loadAsync(file);
        
        projectFiles = {}; 
        document.getElementById('fileContainer').innerHTML = ""; 

        // Load files
        for (let filename in content.files) {
            const fileData = content.files[filename];
            if (!fileData.dir && !filename.includes("__MACOSX")) {
                if(filename.match(/\.(html|css|js|json|txt|php|py)$/i)) {
                    projectFiles[filename] = await fileData.async("string");
                }
            }
        }
        renderFiles();
        document.getElementById('dlAllBtn').style.display = 'block';
    });

    // Render Files & Detect Duplicates
    function renderFiles() {
        const container = document.getElementById('fileContainer');
        container.innerHTML = "";
        
        // Duplicate Logic: Store content hashes to find duplicates
        let contentMap = {};

        for (let filename in projectFiles) {
            const content = projectFiles[filename];
            let isDuplicate = false;

            // Check duplicate by content OR by name pattern (e.g., "index (1).html")
            if (contentMap[content] || filename.match(/\(\d+\)/)) {
                isDuplicate = true;
            } else {
                contentMap[content] = true;
            }

            createFileRow(filename, isDuplicate);
        }
    }

    function createFileRow(filename, isDuplicate) {
        const id = cleanID(filename);
        const div = document.createElement('div');
        div.className = 'file-item';
        div.id = `row-${id}`;

        div.innerHTML = `
            <div class="file-header">
                <div class="file-info" onclick="toggleEditor('${filename}')">
                    <span class="file-name">${filename}</span>
                    <span class="badge-type">${filename.split('.').pop().toUpperCase()}</span>
                    ${isDuplicate ? '<span class="badge-dup" style="display:inline-block">‚ö†Ô∏è DUPLICATE</span>' : ''}
                </div>
                <div class="actions">
                    <button class="btn-edit" onclick="toggleEditor('${filename}')">‚úèÔ∏è Edit</button>
                    <button class="btn-dl" onclick="downloadSingle('${filename}')">‚¨áÔ∏è</button>
                    <button class="btn-del" onclick="deleteFile('${filename}')">üóëÔ∏è</button>
                </div>
            </div>
            
            <div class="editor-area" id="editor-${id}">
                <small style="color:#888;">Current Code:</small>
                <textarea class="code-box" id="code-${id}">${projectFiles[filename]}</textarea>
                
                <div style="margin-top:10px;">
                    <small style="color:#00d2ff;">AI Instruction:</small>
                    <input type="text" class="ai-input" id="prompt-${id}" placeholder="E.g., 'Delete this file if duplicate' or 'Fix the navbar function'...">
                    <button class="btn-ai" id="btn-${id}" onclick="processAI('${filename}')">ü§ñ Apply Changes</button>
                    <div class="loading" id="load-${id}">Processing...</div>
                </div>
            </div>
        `;
        document.getElementById('fileContainer').appendChild(div);
    }

    // Toggle Editor View
    window.toggleEditor = function(filename) {
        const id = cleanID(filename);
        const editor = document.getElementById(`editor-${id}`);
        const codeBox = document.getElementById(`code-${id}`);
        
        // Update code box with latest content before showing
        codeBox.value = projectFiles[filename];
        
        if (editor.style.display === 'block') {
            editor.style.display = 'none';
        } else {
            // Close others (Optional)
            document.querySelectorAll('.editor-area').forEach(el => el.style.display = 'none');
            editor.style.display = 'block';
        }
    }

    // AI Process Logic
    window.processAI = async function(filename) {
        const id = cleanID(filename);
        const prompt = document.getElementById(`prompt-${id}`).value;
        const codeBox = document.getElementById(`code-${id}`); // Get manually edited code too
        
        if(!prompt) {
            // If no AI prompt, just save manual edits
            projectFiles[filename] = codeBox.value;
            alert("Manual Changes Saved!");
            return;
        }

        const btn = document.getElementById(`btn-${id}`);
        const loader = document.getElementById(`load-${id}`);
        
        btn.disabled = true;
        loader.style.display = 'block';

        // Check if user wants to delete via AI
        if (prompt.toLowerCase().includes("delete") || prompt.toLowerCase().includes("remove file")) {
            deleteFile(filename);
            return;
        }

        try {
            const aiPrompt = `
            ACT: Expert Coder.
            FILE: ${filename}
            CODE: ${codeBox.value}
            INSTRUCTION: ${prompt}
            OUTPUT: Only the raw code. No markdown.
            `;
            
            const result = await model.generateContent(aiPrompt);
            const response = await result.response;
            const newCode = response.text().replace(/```(html|css|js|javascript)?/g, "").replace(/```/g, "").trim();
            
            projectFiles[filename] = newCode;
            codeBox.value = newCode; // Update viewer
            
            loader.innerText = "‚úÖ Done!";
            setTimeout(() => { loader.style.display = 'none'; btn.disabled = false; }, 2000);
            
        } catch (error) {
            alert("Error: " + error.message);
            btn.disabled = false;
        }
    }

    // Delete Function
    window.deleteFile = function(filename) {
        if(confirm(`Delete ${filename}?`)) {
            delete projectFiles[filename];
            document.getElementById(`row-${cleanID(filename)}`).remove();
        }
    }

    // Download Single
    window.downloadSingle = function(filename) {
        saveAs(new Blob([projectFiles[filename]], {type: "text/plain"}), filename);
    }

    // Download All
    window.downloadAll = function() {
        const zip = new JSZip();
        for(let f in projectFiles) {
            zip.file(f, projectFiles[f]);
        }
        zip.generateAsync({type:"blob"}).then(c => saveAs(c, "Updated_Project.zip"));
    }

    function cleanID(name) { return name.replace(/[^a-zA-Z0-9]/g, '_'); }
</script>

</body>
</html>
