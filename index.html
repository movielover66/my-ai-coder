<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Smart Code Merger</title>
    
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #0f0f0f;
            color: #e0e0e0;
            padding: 20px;
            margin: 0;
        }
        h2 { color: #00ff88; text-align: center; margin-bottom: 5px; }
        p { text-align: center; color: #888; font-size: 12px; margin-bottom: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        
        /* Sections */
        .box {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
            margin-bottom: 15px;
        }
        .label { color: #00d2ff; font-weight: bold; font-size: 14px; display: block; margin-bottom: 8px; }
        
        /* File Upload */
        input[type="file"] {
            background: #252526;
            color: #fff;
            padding: 10px;
            width: 100%;
            border-radius: 5px;
            border: 1px dashed #555;
            box-sizing: border-box;
        }

        /* Text Area for New Code */
        textarea {
            width: 100%;
            height: 120px;
            background-color: #252526;
            color: #a9ff99; /* Greenish for new code */
            border: 1px solid #333;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 13px;
            box-sizing: border-box; 
        }
        
        /* Merge Button */
        button {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            color: #000;
            background: linear-gradient(45deg, #00ff88, #00d2ff);
            transition: 0.3s;
        }
        button:hover { opacity: 0.9; transform: scale(0.99); }
        button:disabled { background: #555; color: #888; cursor: not-allowed; }

        /* Output Section */
        .output-area { display: none; margin-top: 20px; }
        .download-btn {
            background: #ffc107;
            color: #000;
            margin-top: 10px;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>‚ö° AI Smart Code Merger</h2>
    <p>Upload old file + Paste new part = Full Updated File</p>
    
    <div class="box">
        <span class="label">Step 1: Upload Main File (script.js / index.html)</span>
        <input type="file" id="mainFile" accept=".js,.html,.css,.txt">
    </div>

    <div class="box">
        <span class="label">Step 2: Paste New Code / Instruction</span>
        <textarea id="newSnippet" placeholder="Example: 'Add this startDeepScan function at the bottom' or paste the code directly..."></textarea>
    </div>
    
    <button onclick="mergeCode()" id="mergeBtn">üîÑ MERGE & UPDATE FILE</button>

    <div id="resultArea" class="output-area">
        <div class="box" style="border-color: #00ff88;">
            <span class="label">‚úÖ Merge Successful!</span>
            <pre id="statusText" style="white-space: pre-wrap; color: #ccc; font-size: 12px;">Processing...</pre>
            <button onclick="downloadFixedFile()" class="download-btn">‚¨áÔ∏è Download Updated File</button>
        </div>
    </div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
    import { API_KEY } from './api.js';

    const genAI = new GoogleGenerativeAI(API_KEY);
    const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash" });

    let mainFileContent = "";
    let fileName = "updated_script.js";

    // Read Uploaded File
    document.getElementById('mainFile').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (!file) return;
        fileName = "updated_" + file.name;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            mainFileContent = e.target.result;
            document.getElementById('statusText').innerText = `Loaded: ${file.name} (${mainFileContent.length} chars)`;
        };
        reader.readAsText(file);
    });

    // AI Merge Logic
    window.mergeCode = async function() {
        const newSnippet = document.getElementById("newSnippet").value;
        const statusText = document.getElementById("statusText");
        const resultArea = document.getElementById("resultArea");
        const btn = document.getElementById("mergeBtn");

        if(!mainFileContent) { alert("Please upload the main file first!"); return; }
        if(!newSnippet) { alert("Please paste the new code or instruction!"); return; }

        btn.innerText = "Merging... (Please Wait)";
        btn.disabled = true;
        resultArea.style.display = "block";
        statusText.innerText = "AI is finding the best place to insert your code...";
        
        try {
            const prompt = `You are an expert Code Integrator.
            
            TASK:
            I have a MAIN FILE and a NEW SNIPPET (or instruction).
            Your job is to intelligently merge the NEW SNIPPET into the MAIN FILE.
            
            RULES:
            1. If the new snippet is a function, place it correctly (e.g., at the end or inside a specific class).
            2. If it's a replacement (e.g., "fix button"), find the old code and replace it.
            3. If it's HTML, put it in the correct tag structure.
            4. Output ONLY the FULL, MERGED, READY-TO-USE CODE. No markdown, no text.
            
            --- MAIN FILE START ---
            ${mainFileContent}
            --- MAIN FILE END ---
            
            --- NEW SNIPPET / INSTRUCTION START ---
            ${newSnippet}
            --- NEW SNIPPET / INSTRUCTION END ---
            `;

            const result = await model.generateContent(prompt);
            const response = await result.response;
            const text = response.text();

            // Save result globally for download
            window.finalCode = text.replace(/```(javascript|html|css)?/g, "").replace(/```/g, "").trim();

            statusText.innerText = "Done! The code has been merged and checked.";
            btn.innerText = "Merge Again";
            btn.disabled = false;
        } catch (error) {
            statusText.innerText = "Error: " + error.toString();
            btn.disabled = false;
        }
    }

    // Download Function
    window.downloadFixedFile = function() {
        if(!window.finalCode) return;
        const blob = new Blob([window.finalCode], { type: "text/plain" });
        const anchor = document.createElement("a");
        anchor.href = URL.createObjectURL(blob);
        anchor.download = fileName;
        anchor.click();
    }
</script>

</body>
</html>
