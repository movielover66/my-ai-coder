<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Code Fixer & Reviewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        body {
            font-family: 'Courier New', monospace;
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            margin: 0;
        }
        h2 { color: #61dafb; text-align: center; }
        .container { max-width: 800px; margin: 0 auto; }
        
        /* File Upload Box Styling */
        .file-upload-wrapper {
            background-color: #2d2d2d;
            border: 2px dashed #3e3e3e;
            padding: 20px;
            text-align: center;
            border-radius: 5px;
            margin-bottom: 15px;
            cursor: pointer;
        }
        .file-upload-wrapper:hover { border-color: #61dafb; }
        input[type="file"] { display: none; }
        .custom-file-upload {
            display: inline-block;
            padding: 6px 12px;
            cursor: pointer;
            color: #61dafb;
            font-weight: bold;
        }

        textarea {
            width: 100%;
            height: 200px;
            background-color: #252526;
            color: #fff;
            border: 1px solid #3e3e3e;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
            box-sizing: border-box; /* Fixes width overflow */
        }
        
        button {
            width: 100%;
            padding: 12px;
            background-color: #0e639c;
            color: white;
            border: none;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover { background-color: #1177bb; }

        .output-box {
            margin-top: 20px;
            padding: 15px;
            background-color: #252526;
            border-left: 5px solid #61dafb;
            display: none;
        }
        pre { white-space: pre-wrap; margin: 0; }
    </style>
</head>
<body>

<div class="container">
    <h2>üõ†Ô∏è AI Code Project Reviewer</h2>
    
    <div class="file-upload-wrapper" onclick="document.getElementById('fileInput').click()">
        <label for="fileInput" class="custom-file-upload">
            üìÇ Click to Upload File or ZIP
        </label>
        <div style="font-size: 12px; color: #888;">Supports: .zip, .js, .py, .html, .css</div>
        <input type="file" id="fileInput" accept=".zip,.js,.py,.html,.css,.txt,.json">
    </div>

    <p>Code Preview (AI will read this):</p>
    <textarea id="codeInput" placeholder="Upload a file or paste code here..."></textarea>
    
    <button onclick="fixCode()">Analyze & Fix Code</button>

    <div id="resultArea" class="output-box">
        <span style="font-weight:bold; color:#ce9178">üîé Analysis Result:</span>
        <pre id="outputText">Waiting for AI...</pre>
    </div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
    import { API_KEY } from './api.js';

    // Model Change: Using 'gemini-pro' as it is more stable for code
    const genAI = new GoogleGenerativeAI(API_KEY);
    const model = genAI.getGenerativeModel({ model: "gemini-pro" });

    // --- FILE HANDLING LOGIC ---
    document.getElementById('fileInput').addEventListener('change', async function(event) {
        const file = event.target.files[0];
        if (!file) return;

        const textArea = document.getElementById('codeInput');
        textArea.value = "Reading file... please wait.";

        if (file.name.endsWith('.zip')) {
            // Handle ZIP Files
            try {
                const zip = new JSZip();
                const content = await zip.loadAsync(file);
                let combinedCode = `Project: ${file.name}\n\n`;

                // Loop through files in zip
                for (let filename in content.files) {
                    const zipFile = content.files[filename];
                    // Skip folders and non-code files (images etc)
                    if (!zipFile.dir && !filename.match(/\.(jpg|png|gif|mp4)$/i)) {
                        const fileText = await zipFile.async("string");
                        combinedCode += `--- FILE: ${filename} ---\n${fileText}\n\n`;
                    }
                }
                textArea.value = combinedCode;
            } catch (e) {
                alert("Error reading ZIP: " + e.message);
            }
        } else {
            // Handle Single Code Files
            const reader = new FileReader();
            reader.onload = function(e) {
                textArea.value = e.target.result;
            };
            reader.readAsText(file);
        }
    });

    // --- AI ANALYSIS LOGIC ---
    window.fixCode = async function() {
        const inputCode = document.getElementById("codeInput").value;
        const resultArea = document.getElementById("resultArea");
        const outputText = document.getElementById("outputText");
        const btn = document.querySelector("button");

        if(!inputCode) {
            alert("Code box is empty! Upload a file or write code.");
            return;
        }

        btn.innerText = "Analyzing Project...";
        outputText.innerText = "Thinking...";
        resultArea.style.display = "block";
        
        try {
            const prompt = `You are an expert Lead Developer. 
            Review the following code/project files.
            
            CODE CONTENT:
            ${inputCode}
            
            YOUR TASK:
            1. Identify any critical errors or bugs.
            2. Suggest improvements for better performance or clean code.
            3. Provide corrected snippets for the most important parts.
            
            Keep the response structured and easy to read.`;

            const result = await model.generateContent(prompt);
            const response = await result.response;
            const text = response.text();

            outputText.innerText = text;
        } catch (error) {
            outputText.innerText = "Error: " + error.toString();
        }
        
        btn.innerText = "Analyze & Fix Code";
    }
</script>

</body>
</html>
