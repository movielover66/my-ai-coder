<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Code Fixer (Code Only)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        body {
            font-family: 'Courier New', monospace;
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            margin: 0;
        }
        h2 { color: #28a745; text-align: center; }
        .container { max-width: 800px; margin: 0 auto; }
        
        /* Upload Box */
        .file-upload-wrapper {
            background-color: #2d2d2d;
            border: 2px dashed #3e3e3e;
            padding: 20px;
            text-align: center;
            border-radius: 5px;
            margin-bottom: 15px;
            cursor: pointer;
        }
        input[type="file"] { display: none; }
        .custom-file-upload {
            display: inline-block;
            padding: 6px 12px;
            cursor: pointer;
            color: #28a745;
            font-weight: bold;
        }

        textarea {
            width: 100%;
            height: 150px;
            background-color: #252526;
            color: #fff;
            border: 1px solid #3e3e3e;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 13px;
            box-sizing: border-box; 
        }
        
        /* Buttons Styling */
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        
        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            color: white;
        }
        .btn-analyze { background-color: #0e639c; }
        
        /* Download button styled prominently */
        .btn-download { background-color: #28a745; display: none; } 
        .btn-copy { background-color: #ffc107; color: #000; display: none; }

        .output-box {
            margin-top: 20px;
            padding: 15px;
            background-color: #252526;
            border-left: 5px solid #28a745;
            display: none;
        }
        pre { white-space: pre-wrap; margin: 0; }
    </style>
</head>
<body>

<div class="container">
    <h2>ü§ñ Auto Code Fixer</h2>
    
    <div class="file-upload-wrapper" onclick="document.getElementById('fileInput').click()">
        <label for="fileInput" class="custom-file-upload">
            üìÇ Upload File / ZIP
        </label>
        <div style="font-size: 12px; color: #888;">Supports: .zip, .js, .py, .html, .css</div>
        <input type="file" id="fileInput" accept=".zip,.js,.py,.html,.css,.txt,.json">
    </div>

    <textarea id="codeInput" placeholder="Code preview will appear here..."></textarea>
    
    <button onclick="fixCode()" class="btn-analyze" id="analyzeBtn">Fix My Code</button>

    <div id="resultArea" class="output-box">
        <span style="font-weight:bold; color:#28a745">‚úÖ Fixed Code:</span>
        <pre id="outputText">Waiting for AI...</pre>
        
        <div class="btn-group">
            <button onclick="copyToClipboard()" class="btn-copy" id="copyBtn">üìã Copy Code</button>
            <button onclick="downloadCode()" class="btn-download" id="dlBtn">‚¨áÔ∏è Download Fixed Script</button>
        </div>
    </div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
    import { API_KEY } from './api.js';

    const genAI = new GoogleGenerativeAI(API_KEY);
    // Using Gemini 2.0 Flash for speed and intelligence
    const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash" });

    // --- 1. FILE HANDLING ---
    document.getElementById('fileInput').addEventListener('change', async function(event) {
        const file = event.target.files[0];
        if (!file) return;

        const textArea = document.getElementById('codeInput');
        textArea.value = "Reading file... please wait.";

        if (file.name.endsWith('.zip')) {
            try {
                const zip = new JSZip();
                const content = await zip.loadAsync(file);
                let combinedCode = `/* PROJECT: ${file.name} */\n\n`;
                for (let filename in content.files) {
                    const zipFile = content.files[filename];
                    if (!zipFile.dir && !filename.match(/\.(jpg|png|gif|mp4)$/i)) {
                        const fileText = await zipFile.async("string");
                        combinedCode += `/* --- START FILE: ${filename} --- */\n${fileText}\n/* --- END FILE: ${filename} --- */\n\n`;
                    }
                }
                textArea.value = combinedCode;
            } catch (e) { alert("Error reading ZIP: " + e.message); }
        } else {
            const reader = new FileReader();
            reader.onload = function(e) { textArea.value = e.target.result; };
            reader.readAsText(file);
        }
    });

    // --- 2. AI FIXING LOGIC (STRICT MODE) ---
    window.fixCode = async function() {
        const inputCode = document.getElementById("codeInput").value;
        const resultArea = document.getElementById("resultArea");
        const outputText = document.getElementById("outputText");
        const btn = document.getElementById("analyzeBtn");
        const dlBtn = document.getElementById("dlBtn");
        const copyBtn = document.getElementById("copyBtn");

        if(!inputCode) { alert("Please upload code first!"); return; }

        btn.innerText = "Fixing Code... (Wait)";
        outputText.innerText = "Generating clean code...";
        resultArea.style.display = "block";
        dlBtn.style.display = "none";
        copyBtn.style.display = "none";
        
        try {
            // This prompt forces AI to output ONLY code
            const prompt = `You are a strict code repairing machine.
            
            YOUR TASK:
            Fix all errors (security, logic, syntax) in the code below.
            
            RULES:
            1. Output ONLY the fixed code.
            2. Do NOT write any explanations, comments, or intro text.
            3. Do NOT use markdown code blocks (like \`\`\`). Just raw code.
            4. If there are multiple files, keep the separator comments.
            
            CODE TO FIX:
            ${inputCode.substring(0, 40000)}`;

            const result = await model.generateContent(prompt);
            const response = await result.response;
            const text = response.text();

            outputText.innerText = text;
            
            dlBtn.style.display = "block";
            copyBtn.style.display = "block";
            btn.innerText = "Fix Again";
        } catch (error) {
            outputText.innerText = "Error: " + error.toString();
            btn.innerText = "Retry";
        }
    }

    // --- 3. DOWNLOAD FUNCTION ---
    window.downloadCode = function() {
        const text = document.getElementById("outputText").innerText;
        const blob = new Blob([text], { type: "text/plain" });
        const anchor = document.createElement("a");
        anchor.href = URL.createObjectURL(blob);
        anchor.download = "fixed_script.txt"; // Downloads as text file
        anchor.click();
    }

    window.copyToClipboard = function() {
        const text = document.getElementById("outputText").innerText;
        navigator.clipboard.writeText(text).then(() => {
            alert("Code copied!");
        });
    }
</script>

</body>
</html>
