<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1e1e1e">
    <title>AI Code Studio Pro</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* --- APP STYLE (VS Code Theme) --- */
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: 'Segoe UI', monospace; background: #1e1e1e; color: #ccc; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* Header / Toolbar */
        header { background: #252526; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; height: 50px; }
        h3 { margin: 0; color: #007acc; font-size: 16px; display: flex; align-items: center; gap: 8px; }
        
        .btn-primary { background: #007acc; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; }
        .btn-danger { background: #d9453b; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; }
        
        /* Main Layout */
        .workspace { display: flex; height: calc(100vh - 50px); }
        
        /* Sidebar (File Explorer) */
        .sidebar { width: 250px; background: #252526; border-right: 1px solid #333; overflow-y: auto; display: flex; flex-direction: column; }
        .sidebar-header { padding: 10px; font-size: 11px; font-weight: bold; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        
        .folder-group { margin-bottom: 5px; }
        .folder-title { padding: 5px 15px; color: #fff; font-size: 12px; font-weight: bold; background: #333; cursor: default; }
        
        .file-item { 
            padding: 8px 20px; font-size: 13px; color: #aaa; cursor: pointer; border-left: 3px solid transparent; display: flex; justify-content: space-between; align-items: center;
        }
        .file-item:hover { background: #2a2d2e; color: #fff; }
        .file-item.active { background: #37373d; color: #fff; border-left-color: #007acc; }
        .file-item.duplicate { color: #ff6b6b; }
        
        .badge { font-size: 9px; padding: 2px 4px; border-radius: 3px; }
        .badge-dup { background: #5a1d1d; color: #ff6b6b; }

        /* Editor Area */
        .editor-container { flex: 1; display: flex; flex-direction: column; background: #1e1e1e; position: relative; }
        
        /* Editor Tabs */
        .editor-tabs { display: flex; background: #252526; height: 35px; align-items: center; padding-left: 10px; border-bottom: 1px solid #1e1e1e; }
        .tab-name { font-size: 13px; color: #fff; padding: 5px 10px; background: #1e1e1e; border-top: 2px solid #007acc; }
        .no-file { flex: 1; display: flex; justify-content: center; align-items: center; color: #444; font-size: 20px; flex-direction: column; }

        /* Code Textarea */
        textarea.code-editor {
            flex: 1; width: 100%; background: #1e1e1e; color: #d4d4d4; border: none; padding: 15px;
            font-family: 'Consolas', 'Courier New', monospace; font-size: 14px; line-height: 1.5; resize: none;
        }

        /* AI Action Bar (Bottom) */
        .ai-panel {
            background: #252526; padding: 10px; border-top: 1px solid #333; display: none; /* Hidden until file open */
        }
        .ai-input-group { display: flex; gap: 10px; }
        .ai-input { flex: 1; background: #3c3c3c; border: 1px solid #555; color: white; padding: 8px; border-radius: 4px; }
        .btn-ai { background: linear-gradient(90deg, #007acc, #00d2ff); border: none; padding: 0 20px; font-weight: bold; border-radius: 4px; cursor: pointer; color: #000; }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .workspace { flex-direction: column; }
            .sidebar { width: 100%; height: 35%; border-right: none; border-bottom: 1px solid #333; }
            .editor-container { height: 65%; }
        }
    </style>
</head>
<body>

<header>
    <h3>‚ö° AI Code Studio</h3>
    <div style="display:flex; gap:10px;">
        <input type="file" id="zipInput" accept=".zip" style="display:none">
        <button class="btn-primary" onclick="document.getElementById('zipInput').click()">üìÇ Open ZIP</button>
        <button class="btn-primary" id="dlBtn" onclick="downloadZip()" style="display:none; background:#28a745;">‚¨áÔ∏è Save ZIP</button>
    </div>
</header>

<div class="workspace">
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">EXPLORER</div>
        <div id="fileList">
            <div style="padding:20px; text-align:center; color:#555;">No Project Loaded</div>
        </div>
    </div>

    <div class="editor-container">
        <div class="editor-tabs" id="editorHeader" style="display:none;">
            <span class="tab-name" id="currentFileName">script.js</span>
            <div style="flex:1; text-align:right; padding-right:10px;">
                <button class="btn-danger" onclick="deleteCurrentFile()">üóëÔ∏è Delete File</button>
            </div>
        </div>

        <div id="emptyState" class="no-file">
            <p>Select a file to edit</p>
        </div>
        
        <textarea class="code-editor" id="codeEditor" spellcheck="false" style="display:none;"></textarea>

        <div class="ai-panel" id="aiPanel">
            <div style="margin-bottom:5px; font-size:12px; color:#888;">AI Instructions (Update/Replace):</div>
            <div class="ai-input-group">
                <input type="text" class="ai-input" id="aiPrompt" placeholder="E.g. 'Add a login function' or 'Remove duplicates'...">
                <button class="btn-ai" id="aiBtn" onclick="runAI()">‚ú® RUN AI</button>
            </div>
            <div id="aiStatus" style="font-size:11px; color:#00ff88; margin-top:5px; height:15px;"></div>
        </div>
    </div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
    import { API_KEY } from './api.js'; // Ensure api.js is in the same folder

    const genAI = new GoogleGenerativeAI(API_KEY);
    const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash" });

    let files = {}; // Stores filename -> content
    let currentFile = null;

    // --- 1. ZIP HANDLING & AUTO-SORT ---
    document.getElementById('zipInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const zip = new JSZip();
        const content = await zip.loadAsync(file);
        
        files = {};
        
        // Load and check duplicates based on content hash
        let contentHashes = new Set();
        let duplicates = [];

        for (let name in content.files) {
            const f = content.files[name];
            if (!f.dir && !name.includes("__MACOSX")) {
                const text = await f.async("string");
                
                // Simple Hash Check
                const hash = text.length + "-" + text.substring(0, 50);
                let isDup = false;
                
                if (contentHashes.has(hash)) {
                    isDup = true;
                    // Auto-tag duplicate in filename for UI
                    files[name + " [DUPLICATE]"] = text;
                } else {
                    contentHashes.add(hash);
                    files[name] = text;
                }
            }
        }
        renderSidebar();
        document.getElementById('dlBtn').style.display = 'block';
    });

    // --- 2. RENDER SIDEBAR (Auto-Folder Logic) ---
    function renderSidebar() {
        const list = document.getElementById('fileList');
        list.innerHTML = "";

        // Categories
        const categories = {
            "üåê HTML Views": [],
            "üé® Styles (CSS)": [],
            "‚öôÔ∏è Scripts (JS)": [],
            "üîß Config/API": [],
            "üìÑ Others": []
        };

        Object.keys(files).sort().forEach(name => {
            const lower = name.toLowerCase();
            if (lower.includes('.html')) categories["üåê HTML Views"].push(name);
            else if (lower.includes('.css')) categories["üé® Styles (CSS)"].push(name);
            else if (lower.includes('.js')) categories["‚öôÔ∏è Scripts (JS)"].push(name);
            else if (lower.includes('.json') || lower.includes('api')) categories["üîß Config/API"].push(name);
            else categories["üìÑ Others"].push(name);
        });

        // Generate HTML
        for (let [catName, fileArr] of Object.entries(categories)) {
            if (fileArr.length > 0) {
                const group = document.createElement('div');
                group.className = 'folder-group';
                group.innerHTML = `<div class="folder-title">${catName}</div>`;
                
                fileArr.forEach(fname => {
                    const isDup = fname.includes("[DUPLICATE]");
                    const cleanName = fname.replace(" [DUPLICATE]", "");
                    
                    const item = document.createElement('div');
                    item.className = `file-item ${isDup ? 'duplicate' : ''}`;
                    item.innerHTML = `
                        <span>${cleanName}</span>
                        ${isDup ? '<span class="badge badge-dup">DUP</span>' : ''}
                    `;
                    item.onclick = () => openFile(fname, item);
                    group.appendChild(item);
                });
                list.appendChild(group);
            }
        }
    }

    // --- 3. EDITOR LOGIC ---
    function openFile(name, element) {
        currentFile = name;
        
        // Highlight active sidebar item
        document.querySelectorAll('.file-item').forEach(el => el.classList.remove('active'));
        element.classList.add('active');

        // Show Editor
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('editorHeader').style.display = 'flex';
        document.getElementById('codeEditor').style.display = 'block';
        document.getElementById('aiPanel').style.display = 'block';
        
        document.getElementById('currentFileName').innerText = name.replace(" [DUPLICATE]", "");
        document.getElementById('codeEditor').value = files[name];
    }

    // --- 4. DELETE FUNCTION ---
    window.deleteCurrentFile = function() {
        if (!currentFile) return;
        if(confirm(`Delete ${currentFile}?`)) {
            delete files[currentFile];
            currentFile = null;
            document.getElementById('emptyState').style.display = 'flex';
            document.getElementById('codeEditor').style.display = 'none';
            document.getElementById('aiPanel').style.display = 'none';
            document.getElementById('editorHeader').style.display = 'none';
            renderSidebar();
        }
    }

    // --- 5. AI SMART UPDATE ---
    window.runAI = async function() {
        const prompt = document.getElementById('aiPrompt').value;
        const btn = document.getElementById('aiBtn');
        const status = document.getElementById('aiStatus');
        const editor = document.getElementById('codeEditor');

        if (!currentFile || !prompt) return;

        // UI Loading
        btn.disabled = true;
        btn.style.opacity = 0.5;
        status.innerText = "ü§ñ AI is thinking & coding...";

        try {
            const aiPrompt = `
            ROLE: Senior Software Engineer.
            TASK: Edit the following code based on user instruction.
            FILE NAME: ${currentFile}
            USER INSTRUCTION: "${prompt}"
            
            CURRENT CODE:
            ${files[currentFile]}
            
            OUTPUT RULES:
            1. Return ONLY the full updated code.
            2. Do NOT use markdown blocks (\`\`\`).
            3. If user says "clean duplicates", keep only unique logic.
            `;

            const result = await model.generateContent(aiPrompt);
            const response = await result.response;
            let newCode = response.text();
            
            // Clean cleanup
            newCode = newCode.replace(/```(javascript|html|css|json)?/g, "").replace(/```/g, "").trim();

            // Update UI & Data
            files[currentFile] = newCode;
            editor.value = newCode;
            status.innerText = "‚úÖ Code Updated Successfully!";
            
        } catch (error) {
            status.innerText = "‚ùå Error: " + error.message;
        } finally {
            btn.disabled = false;
            btn.style.opacity = 1;
        }
    }

    // --- 6. DOWNLOAD ZIP ---
    window.downloadZip = function() {
        const zip = new JSZip();
        Object.keys(files).forEach(name => {
            // Remove [DUPLICATE] tag from filename before saving
            const cleanName = name.replace(" [DUPLICATE]", "");
            zip.file(cleanName, files[name]);
        });
        zip.generateAsync({type:"blob"}).then(c => saveAs(c, "Pro_Project_Updated.zip"));
    }
</script>

</body>
</html>
